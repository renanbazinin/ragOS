{
  "metadata": {
    "source": "ai_generated",
    "subject": "Virtualization",
    "topic_hint": "TLB",
    "requested_type": "Open",
    "requested_difficulty": "Hard",
    "generated_at": "2026-02-08 08:19:02",
    "examples_used": 3,
    "token_usage": {
      "prompt_tokens": 4186,
      "output_tokens": 3176,
      "total_tokens": 16785
    }
  },
  "question": {
    "id": 1,
    "type": "Open",
    "topic": [
      "TLB",
      "Virtual Memory",
      "Paging",
      "Memory Management"
    ],
    "content": {
      "text": "מערכת הפעלה מתקדמת משתמשת בזיכרון וירטואלי ובמנגנון TLB (Translation Lookaside Buffer) לזירוז תרגום כתובות. נתונים הפרמטרים הבאים של המערכת:\n\n*   **כתובת וירטואלית:** 48 ביטים.\n*   **כתובת פיזית:** 40 ביטים.\n*   **גודל דף:** 4KB (קילובייט).\n*   **גודל כניסה בטבלת דפים (PTE):** 8 בתים.\n*   **טבלת דפים:** היררכית, 4 רמות.\n*   **TLB:** מכיל 64 כניסות, 4-כיווני אסוציאטיבי (4-way set associative), עם מדיניות החלפה LRU (Least Recently Used) בתוך כל סט.\n\nנתון קטע הקוד הבא ב-C/C++:\n\nהנח כי המערך `arr` מיושר לגבול דף (page-aligned) בזיכרון הוירטואלי, ושהוא מוקצה ברצף בזיכרון הוירטואלי. כמו כן, כל גישה לזיכרון בתוך הלולאה גורמת לחיפוש ב-TLB (כלומר, כל גישה ל-`arr[i]`). יש לפרט ולנמק את כל החישובים בכל סעיף.",
      "code_snippet": "#define ARRAY_SIZE (1024 * 1024) // 1M integers\n#define STRIDE 1024 // Access every 1024th integer\n\nint main() {\n    int* arr = new int[ARRAY_SIZE];\n    for (int i = 0; i < ARRAY_SIZE; i += STRIDE) {\n        arr[i] = arr[i] + 1; // Read and write access\n    }\n    // Assume arr starts at a page-aligned virtual address\n    // and is allocated contiguously in virtual memory.\n    // Assume each int is 4 bytes.\n    return 0;\n}"
    },
    "sub_questions": [
      {
        "id": "1.1",
        "text": "פרט את מבנה כתובת ה-VPN (Virtual Page Number) ורמות טבלת הדפים. כמה ביטים מוקדשים לכל אינדקס ברמה בטבלת הדפים, וכמה ביטים לאופסט הדף?",
        "code_snippet": null,
        "options": null
      },
      {
        "id": "1.2",
        "text": "כמה דפים וירטואליים ייחודיים ניגשים במהלך ריצת הלולאה? כמה כניסות TLB ייחודיות (VPN, PFN) ייווצרו כתוצאה מכך?",
        "code_snippet": null,
        "options": null
      },
      {
        "id": "1.3",
        "text": "מה יהיה אחוז הפגיעות (Hit Rate) ב-TLB עבור גישות הזיכרון בלולאה, בהתחשב בפרמטרי ה-TLB הנתונים? פרט ונמק את חישוביך.",
        "code_snippet": null,
        "options": null
      },
      {
        "id": "1.4",
        "text": "כיצד תשפיע החלפת הקשר (Context Switch) תכופה (ללא שימוש ב-ASIDs) על ביצועי הלולאה מבחינת גישות ל-TLB? הסבר.",
        "code_snippet": null,
        "options": null
      }
    ],
    "points": null,
    "solution": {
      "is_present_in_file": true,
      "correct_option": null,
      "explanation": "1.1: חישוב מבנה כתובת ה-VPN ורמות טבלת הדפים:\n*   **גודל דף:** 4KB = 2^12 בתים. לכן, אופסט הדף (Page Offset) הוא 12 ביטים.\n*   **כתובת וירטואלית:** 48 ביטים. מספר הדף הוירטואלי (VPN) הוא 48 - 12 = 36 ביטים.\n*   **גודל כניסה בטבלת דפים (PTE):** 8 בתים.\n*   **מספר כניסות לכל דף טבלת דפים:** גודל דף / גודל PTE = 4KB / 8 בתים = 4096 / 8 = 512 כניסות. לכן, כל אינדקס ברמת טבלת דפים יהיה בגודל log2(512) = 9 ביטים.\n*   **מספר רמות טבלת דפים:** מכיוון ש-VPN הוא 36 ביטים וכל אינדקס הוא 9 ביטים, נדרשות 36 / 9 = 4 רמות של טבלת דפים.\n    מבנה ה-VPN יהיה: VPN_L1 (9 ביטים) | VPN_L2 (9 ביטים) | VPN_L3 (9 ביטים) | VPN_L4 (9 ביטים).\n\n1.2: דפים וירטואליים ייחודיים וכניסות TLB:\n*   **גודל המערך `arr`:** ARRAY_SIZE * sizeof(int) = 1024 * 1024 * 4 בתים = 4MB.\n*   **מספר הדפים שהמערך תופס:** גודל המערך / גודל דף = 4MB / 4KB = (4 * 1024KB) / 4KB = 1024 דפים וירטואליים רצופים.\n*   **תבנית הגישה:** `i += STRIDE`, כאשר STRIDE = 1024. כל גישה היא ל-`arr[k * 1024]` עבור `k` מ-0 עד 1023.\n*   **כתובת בתוך המערך:** `(k * 1024) * 4` בתים מההתחלה. זה שווה ל-`k * 4096` בתים, שהם בדיוק `k` דפים.\n*   **דפים נגישים:** כל גישה `arr[k * 1024]` ממופה לתחילת הדף הווירטואלי ה-`k` מתוך 1024 הדפים שהמערך תופס. לדוגמה, `arr[0]` ניגש לדף 0, `arr[1024]` ניגש לדף 1, וכן הלאה.\n*   **דפים ייחודיים:** הלולאה מבצעת 1024 איטרציות, וכל איטרציה ניגשת לדף וירטואלי *שונה* וייחודי (P_0, P_1, ..., P_1023) שטרם נגשו אליו באותה ריצת לולאה. לכן, 1024 דפים וירטואליים ייחודיים ניגשים במהלך הלולאה.\n*   **כניסות TLB ייחודיות:** כל גישה לדף ייחודי תיצור כניסת TLB ייחודית (VPN, PFN). לכן, ייווצרו 1024 כניסות TLB ייחודיות בסך הכל.\n\n1.3: אחוז הפגיעות (Hit Rate) ב-TLB:\n*   **TLB:** 64 כניסות, 4-כיווני אסוציאטיבי. מספר הסטים ב-TLB הוא 64 כניסות / 4 כניסות לסט = 16 סטים.\n*   **תבנית הגישה:** כפי שחושב בסעיף הקודם, הלולאה ניגשת ברצף ל-1024 דפים וירטואליים ייחודיים (P_0, P_1, ..., P_1023). נניח ש-VPN של P_0 הוא V_0. אז ה-VPN של P_k הוא V_0 + k.\n*   **מיפוי לסטים ב-TLB:** כל VPN ממופה לסט מסוים ב-TLB על ידי `VPN % Num_Sets`. לדוגמה, P_0 לסט `V_0 % 16`, P_1 לסט `(V_0+1) % 16`, וכן הלאה.\n*   **ניתוח פגיעות/החטאות:**\n    1.  הגישה הראשונה לכל אחד מ-1024 הדפים (P_0 עד P_1023) תגרום בהכרח ל-TLB Miss, מכיוון שהדף טרם נטען ל-TLB.\n    2.  מכיוון שכל גישה בלולאה היא לדף *שונה* וייחודי (שלא נגשו אליו קודם בלולאה), כל 1024 הגישות יהיו גישות ראשוניות לדפים אלו.\n    3.  ה-TLB יכול להכיל לכל היותר 64 כניסות. אנו ניגשים ל-1024 דפים ייחודיים. מכיוון ש-1024 > 64, ה-TLB לא יכול להכיל את כל המיפויים הנדרשים.\n    4.  יתרה מכך, כל סט ב-TLB יכול להכיל רק 4 כניסות. כל סט 'מקבל' 1024 / 16 = 64 דפים שונים מהרצף של המערך. לכן, כאשר ניגשים לדף ה-5 שמתמפה לאותו סט, תתרחש בהכרח החלפה (LRU תפנה את הכניסה שהייתה הכי פחות בשימוש מבין ה-4). בכל גישה הבאה לאותו סט, ייטען דף חדש ויפונה דף ישן.\n*   **מסקנה:** כל 1024 הגישות לזיכרון בתוך הלולאה יגרמו ל-TLB Miss, מכיוון שכל גישה היא לדף ייחודי חדש, וה-TLB קטן מכדי להכיל את כל הדפים שנגשים אליהם, וגם מדיניות הגישה (Large Stride) גורמת לכך שאין חזרתיות בגישות לדפים שכבר נטענו ל-TLB.\n*   **אחוז הפגיעות (Hit Rate):** 0 פגיעות / 1024 גישות = 0%.\n\n1.4: השפעת החלפת הקשר (Context Switch) תכופה:\n*   **ללא ASIDs:** כאשר מתרחשת החלפת הקשר ללא שימוש ב-ASIDs (Address Space Identifiers), יש לרוקן (flush) את כל כניסות ה-TLB. הסיבה לכך היא שמיפויי הכתובות הוירטואליות-לפיזיות שונים עבור תהליכים שונים, וכדי למנוע שגיאות אבטחה או תרגום שגוי, יש לוודא שה-TLB לא מכיל כניסות של תהליכים קודמים.\n*   **השפעה על ביצועי הלולאה:**\n    1.  **במקרה הספציפי של לולאה זו:** מכיוון שאחוז הפגיעות ב-TLB הוא ממילא 0% (כל גישה היא TLB Miss), החלפת הקשר תכופה לא תשנה את אחוז הפגיעות *בתוך* ריצה שלמה של הלולאה. כלומר, גם אם אין החלפת קשר, כל גישה תהיה Miss. אם יש החלפת קשר, ה-TLB ירוקן, אבל מאחר שכל גישה היא לדף חדש, ה-Miss היה מתרחש בכל מקרה.\n    2.  **השפעה כללית על מערכות אחרות או על ביצועי הלולאה אם היו פגיעות:** במקרה כללי, כאשר יש החלפת קשר תכופה ותהליכים רבים מתחרים על זמן מעבד, ה-TLB ירוקן שוב ושוב. פעולה זו מבטלת את היתרון של ה-TLB בשמירת מיפויים בשימוש תכוף. כתוצאה מכך, קצב הפגיעות ב-TLB ירד משמעותית עבור תהליכים רבים, מה שיגדיל את מספר הגישות לטבלת הדפים בזיכרון הראשי (שהיא איטית בהרבה), ויפגע קשות בביצועי המערכת כולה. במקרה של לולאה זו, אם ה-STRIDE היה קטן והיו גישות חוזרות לאותם דפים, החלפת קשר הייתה גורמת ל-Misses חוזרים על דפים שכבר נטענו, ובכך פוגעת בביצועים."
    },
    "difficulty_estimation": "Hard"
  }
}