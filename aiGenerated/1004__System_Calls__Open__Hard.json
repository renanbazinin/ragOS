{
  "metadata": {
    "source": "ai_generated",
    "subject": "Virtualization",
    "topic_hint": "System Calls",
    "requested_type": "Open",
    "requested_difficulty": "Hard",
    "generated_at": "2026-02-08 07:22:16",
    "examples_used": 3,
    "token_usage": {
      "prompt_tokens": 3498,
      "output_tokens": 1692,
      "total_tokens": 8402
    }
  },
  "question": {
    "id": 7,
    "type": "Open",
    "topic": [
      "System Calls",
      "Performance",
      "I/O",
      "Buffering"
    ],
    "content": {
      "text": "נתונה תוכנית C שצריכה לכתוב מיליון מחרוזות קצרות, כל אחת באורך של תו אחד (למשל 'a', 'b', וכו'), לקובץ. המתכנת כתב את הקוד הבא:",
      "code_snippet": "#include <unistd.h>\n#include <fcntl.h>\n#include <stdio.h> // for perror\n\nint main() {\n    int fd = open(\"output.txt\", O_WRONLY | O_CREAT | O_TRUNC, 0644);\n    if (fd == -1) {\n        perror(\"open failed\");\n        return 1;\n    }\n\n    for (int i = 0; i < 1000000; ++i) {\n        char c = 'a' + (i % 26); // Cycle through 'a' to 'z'\n        if (write(fd, &c, 1) == -1) {\n            perror(\"write failed\");\n            close(fd);\n            return 1;\n        }\n    }\n\n    close(fd);\n    return 0;\n}",
      "options": null
    },
    "sub_questions": [
      {
        "id": "7.1",
        "text": "הסבר מדוע גישה זו לכתיבה לקובץ אינה יעילה מבחינת ביצועים, תוך התייחסות למנגנון קריאות המערכת (System Calls) ומעבר הקשר (Context Switching).",
        "code_snippet": null,
        "options": null
      },
      {
        "id": "7.2",
        "text": "הצע פתרון חלופי (בעזרת קוד C או תיאור מפורט) שישפר משמעותית את ביצועי הכתיבה במקרה זה. הסבר כיצד הפתרון המוצע מפחית את מספר קריאות המערכת.",
        "code_snippet": null,
        "options": null
      },
      {
        "id": "7.3",
        "text": "בהנחה שכל קריאת מערכת `write` גוררת עלות קבועה כלשהי, ובהשוואה לפתרון שהצעת בסעיף 7.2 (לדוגמה, שימוש ב-`fwrite` עם גודל באפר סביר), בכמה סדרי גודל (בערך) ניתן לצפות לשיפור בביצועים מבחינת מספר קריאות המערכת?",
        "code_snippet": null,
        "options": null
      }
    ],
    "points": null,
    "solution": {
      "is_present_in_file": true,
      "correct_option": null,
      "explanation": "7.1: בגישה הנוכחית, התוכנית מבצעת מיליון קריאות למערכת (`write`) עבור כל תו בנפרד. כל קריאת מערכת דורשת מעבר קשר (Context Switch) ממצב משתמש (User Mode) למצב קרנל (Kernel Mode) ובחזרה, פעולה שהיא יקרה יחסית מבחינת זמן מעבד. מעבר זה כולל שמירה ושחזור של מצב המעבד, בדיקות הרשאות, וביצוע הלוגיקה בקרנל. ביצוע מיליון מעברי קשר עבור כתיבת בתים בודדים גורם לעלות תקורה גבוהה מאוד שתפגע קשות בביצועי התוכנית.\n\n7.2: פתרון יעיל יותר הוא להשתמש בחיץ (buffer) ברמת המשתמש. במקום לבצע קריאת מערכת עבור כל תו בנפרד, נצבור מספר תווים בזיכרון התוכנית (בחיץ) ורק כאשר החיץ יתמלא, או בעת סגירת הקובץ, נבצע קריאת מערכת `write` אחת גדולה עבור כל תכולת החיץ.\nספריות קלט/פלט סטנדרטיות כמו `stdio.h` (לדוגמה, פונקציות `fprintf`, `fwrite`, `putc`) מממשות מנגנון חיץ כזה באופן אוטומטי.\n\nדוגמת קוד משופרת באמצעות `fprintf`:\n```c\n#include <stdio.h> // for fopen, fprintf, fclose\n\nint main() {\n    FILE *fp = fopen(\"output_buffered.txt\", \"w\");\n    if (fp == NULL) {\n        perror(\"fopen failed\");\n        return 1;\n    }\n\n    for (int i = 0; i < 1000000; ++i) {\n        char c = 'a' + (i % 26);\n        if (fprintf(fp, \"%c\", c) < 0) { // או putc(c, fp)\n             perror(\"fprintf failed\");\n             fclose(fp);\n             return 1;\n        }\n    }\n\n    fclose(fp); // סגירת הקובץ מבצעת flush לחיץ הפנימי של fprintf\n    return 0;\n}\n```\nפתרון זה מפחית באופן דרמטי את מספר קריאות המערכת, מכיוון שכל קריאת `fprintf` (או `putc`) אינה בהכרח קריאת מערכת בפני עצמה, אלא רק מוסיפה נתונים לחיץ. קריאת מערכת `write` תתבצע רק כאשר החיץ הפנימי של הספרייה יתמלא.\n\n7.3: בהנחה שספריית `stdio` משתמשת בחיץ פנימי בגודל טיפוסי, למשל 4KB (4096 בתים).\nהתוכנית המקורית מבצעת 1,000,000 קריאות מערכת (`write`), אחת לכל תו.\nהתוכנית המשופרת (באמצעות `fprintf` או `fwrite`) תבצע קריאת מערכת `write` רק כאשר החיץ הפנימי מתמלא. עבור 1,000,000 תווים וחיץ בגודל 4096 בתים, מספר קריאות המערכת יהיה כ- 1,000,000 / 4096 ≈ 244 קריאות מערכת, בתוספת קריאת מערכת אחת או שתיים עבור שאר הנתונים וסגירת הקובץ.\nזהו שיפור דרמטי. מספר קריאות המערכת יופחת מכ-1,000,000 לכמה מאות בודדות. מדובר על שיפור של כ-3 עד 4 סדרי גודל (פי 4,000 עד 10,000 בקירוב) מבחינת מספר קריאות המערכת."
    },
    "difficulty_estimation": "Hard"
  }
}