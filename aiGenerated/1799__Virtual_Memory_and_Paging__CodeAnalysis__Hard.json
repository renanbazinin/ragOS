{
  "metadata": {
    "source": "ai_generated",
    "subject": "Virtualization",
    "topic_hint": "Virtual Memory and Paging",
    "requested_type": "CodeAnalysis",
    "requested_difficulty": "Hard",
    "generated_at": "2026-02-08 20:54:24",
    "examples_used": 3,
    "token_usage": {
      "prompt_tokens": 2792,
      "output_tokens": 2767,
      "total_tokens": 17138
    }
  },
  "question": {
    "id": 1,
    "type": "CodeAnalysis",
    "topic": [
      "Virtual Memory",
      "Paging",
      "Page Faults",
      "TLB",
      "Spatial Locality"
    ],
    "content": {
      "text": "נתונה תוכנית בשפת C המבצעת איפוס של מטריצה דו-ממדית גדולה מאוד. המטריצה מוגדרת כ- `int matrix[ROWS][COLS];` כאשר `ROWS = 4096` ו- `COLS = 4096`. כל `int` תופס 4 בתים.\nגודל דף (Page Size) במערכת ההפעלה הוא 4 קילובייט (4KB).\n\nבחנו את שני קטעי הקוד הבאים, המבצעים את אותה פעולה של איפוס המטריצה, אך בסדר גישה שונה לזיכרון:\n\n**קטע קוד 1 (גישה לפי שורות):**",
      "code_snippet": "#define ROWS 4096\n#define COLS 4096\nint matrix[ROWS][COLS]; // גלובלי או מוקצה דינמית\n\nvoid initialize_row_major() {\n    for (int i = 0; i < ROWS; i++) {\n        for (int j = 0; j < COLS; j++) {\n            matrix[i][j] = i + j; \n        }\n    }\n}\n\n// קטע קוד 2 (גישה לפי עמודות):\n\nvoid initialize_col_major() {\n    for (int j = 0; j < COLS; j++) {\n        for (int i = 0; i < ROWS; i++) {\n            matrix[i][j] = i + j; \n        }\n    }\n}",
      "options": null
    },
    "sub_questions": null,
    "points": 20,
    "solution": {
      "is_present_in_file": false,
      "correct_option": null,
      "explanation": "נתונים:\n-   מטריצה: `int matrix[4096][4096]`\n-   גודל `int`: 4 בתים\n-   גודל דף: 4KB = 4096 בתים\n\nחישובים מקדימים:\n-   גודל שורה בבתים: `4096 (COLS) * 4 (sizeof(int)) = 16384` בתים.\n-   מספר דפים לשורה: `16384 / 4096 = 4` דפים.\n-   גודל כולל של המטריצה: `4096 * 4096 * 4 = 64` מגה-בייט.\n-   מספר הדפים הכולל של המטריצה: `64MB / 4KB = 16384` דפים.\n\n**ניתוח קטע קוד 1 (גישה לפי שורות - Row-Major):**\n\n1.  **תקלות דף (Page Faults):**\n    *   בלולאה הפנימית, כאשר `i` קבוע ו-`j` משתנה, הגישה ל-`matrix[i][j]` היא רציפה בזיכרון. כל שורה תופסת 4 דפים. כשהלולאה הפנימית מתקדמת על שורה מסוימת, היא תגרום לכל היותר ל-4 תקלות דף (אחת עבור כל דף שהשורה משתרעת עליו), כאשר הדפים הללו נטענים לזיכרון הפיזי. לאחר מכן, הגישה לאלמנטים נוספים באותם 4 דפים תהיה \"פגיעת דף\" (Page Hit) ולא תקלות דף נוספות.\n    *   ישנן `ROWS = 4096` שורות במטריצה. כל שורה דורשת גישה ל-4 דפים חדשים (שלא נגשו אליהם קודם). מכיוון שהגישה היא סדרתית, ובהנחה ש-4 הדפים של שורה אחת נשארים בזיכרון בזמן עיבוד השורה, אך עשויים להיפלט כאשר עוברים לשורות הבאות (בגלל זיכרון פיזי מוגבל), סך תקלות הדף יהיה קרוב למספר הדפים הכולל במטריצה.\n    *   **הערכה:** `4096 (ROWS) * 4 (pages per row) = 16384` תקלות דף. זוהי הערכה אופטימית של תקלות הדף המינימליות – כל דף נטען פעם אחת בלבד. במקרה שהזיכרון הפיזי קטן מאוד, ייתכנו מעט יותר תקלות דף, אך זה עדיין יהיה היעיל ביותר.\n\n2.  **פספוסי TLB (TLB Misses):**\n    *   בדומה לתקלות הדף, הגישה לכל דף חדש תגרום לפספוס TLB אחד כדי לטעון את תרגום הכתובת שלו ל-TLB. לאחר מכן, כל עוד תרגום הכתובת נשאר ב-TLB, הגישות הבאות לאלמנטים באותו דף יהיו \"פגיעת TLB\" (TLB Hit).\n    *   **הערכה:** בקירוב `16384` פספוסי TLB (אחד עבור כל דף ייחודי במטריצה).\n\n**ניתוח קטע קוד 2 (גישה לפי עמודות - Column-Major):**\n\n1.  **תקלות דף (Page Faults):**\n    *   בלולאה הפנימית, כאשר `j` קבוע ו-`i` משתנה, הגישה ל-`matrix[i][j]` אינה רציפה בזיכרון. הכתובת של `matrix[i+1][j]` מרוחקת מהכתובת של `matrix[i][j]` ב-`COLS * sizeof(int) = 16384` בתים, שהם `4 * PageSize`. כלומר, כל גישה ל-`matrix[i][j]` עבור `i` עוקב תהיה לדף חדש, המרוחק 4 דפים מהדף הקודם שנגשו אליו.\n    *   עבור `j` קבוע, הלולאה הפנימית מבצעת `ROWS = 4096` גישות. כל אחת מהגישות הללו היא ככל הנראה לדף אחר לגמרי (או לדף שהוצא מהזיכרון מזמן). אם מספר מסגרות הדף הפיזיות הזמינות קטן מ-`4096` (לדוגמה, אם יש רק כמה מאות MB של זיכרון פיזי זמין), כמעט כל גישה ל-`matrix[i][j]` עבור `i` חדש תגרום לתקלת דף, כיוון שהדף הנדרש כבר לא נמצא בזיכרון הפיזי (או שלא היה בו מעולם).\n    *   **הערכה:** `COLS * ROWS = 4096 * 4096 = 16,777,216` תקלות דף. זוהי הערכה פסימית, אך סבירה מאוד בהינתן זיכרון פיזי מוגבל ואלגוריתם החלפת דפים כמו LRU. כל גישה לדף חדש גורמת לתקלת דף, וכל דף נטען מחדש כמעט בכל פעם שנגשים אליו בעמודה אחרת (או אפילו באותה עמודה, אם הזיכרון הפיזי קטן מ-4096 דפים).\n\n2.  **פספוסי TLB (TLB Misses):**\n    *   בדומה לתקלות הדף, מכיוון שכל גישה היא כנראה לדף אחר, כמעט כל גישה ל-`matrix[i][j]` תגרום לפספוס TLB, שכן תרגום הכתובת לדף זה לא יהיה קיים ב-TLB. ה-TLB לא יוכל להכיל `4096` כניסות עבור עמודה אחת, ולכן תרגומי כתובות ייפלטו כל הזמן.\n    *   **הערכה:** בקירוב `16,777,216` פספוסי TLB.\n\n**הבדל בביצועים וההסבר:**\n\nההבדל המשמעותי בביצועים נובע מחוסר **לוקליות מרחבית (Spatial Locality)** בקטע קוד 2, לעומת לוקליות מרחבית גבוהה בקטע קוד 1.\n\n*   **קטע קוד 1 (Row-Major):** הגישה לזיכרון היא רציפה (או כמעט רציפה). כאשר דף נטען לזיכרון הפיזי (בעקבות תקלת דף), הוא מכיל מספר רב של אלמנטים (`1024` אלמנטים) שייגשו אליהם מיד לאחר מכן. זה מנצל את עקרון הלוקליות המרחבית בצורה אופטימלית: ברגע שדף נטען, הוא מספק נתונים רבים שבהם יש צורך מיידי, מה שממזער את מספר תקלות הדף ופספוסי ה-TLB הכולל. עלויות הכרוכות בטעינת דפים מאיטיון אחסון (כמו דיסק) או חיפוש בטבלאות דפים, משולמות פעם אחת עבור קבוצה גדולה של נתונים.\n\n*   **קטע קוד 2 (Column-Major):** הגישה לזיכרון היא \"מדלגת\" (strided). כל גישה ל-`matrix[i][j]` ומיד אחריה ל-`matrix[i+1][j]` קופצת 4 דפים בזיכרון הוירטואלי. המשמעות היא שכמעט כל גישה היא לדף חדש שאינו נמצא בזיכרון הפיזי (או ב-TLB), מה שגורם למספר עצום של תקלות דף ופספוסי TLB. כל תקלת דף כרוכה בהשהיה משמעותית (גישה לדיסק או לזיכרון איטי יותר לטבלאות דפים), וכל פספוס TLB דורש חיפוש יקר בטבלאות הדפים. למרות שכל הדפים במטריצה נגשים בסופו של דבר, הסדר הלא רציף של הגישות גורם לכך שדפים נטענים ונפלטים שוב ושוב מהזיכרון הפיזי (ומטבלאת ה-TLB) מבלי שהתוכנית תספיק לנצל את התוכן שלהם באופן מלא לפני שהם מוחלפים. זה מוביל לביצועים גרועים משמעותית.\n\nלסיכום, ההבדל נובע מכך שקטע קוד 1 מנצל היטב את הלוקליות המרחבית, מה שמוביל למעט תקלות דף ופספוסי TLB יחסית, בעוד קטע קוד 2 מפר את הלוקליות המרחבית, וגורם למספר עצום של תקלות דף ופספוסי TLB, ובכך פוגע קשות בביצועים."
    },
    "difficulty_estimation": "Hard"
  }
}