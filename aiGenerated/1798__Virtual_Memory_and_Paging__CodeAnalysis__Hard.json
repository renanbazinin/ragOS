{
  "metadata": {
    "source": "ai_generated",
    "subject": "Virtualization",
    "topic_hint": "Virtual Memory and Paging",
    "requested_type": "CodeAnalysis",
    "requested_difficulty": "Hard",
    "generated_at": "2026-02-08 20:53:24",
    "examples_used": 3,
    "token_usage": {
      "prompt_tokens": 2792,
      "output_tokens": 4622,
      "total_tokens": 19942
    }
  },
  "question": {
    "id": 1,
    "type": "CodeAnalysis",
    "topic": [
      "Virtual Memory",
      "Paging",
      "TLB",
      "Page Faults",
      "Memory Locality"
    ],
    "content": {
      "text": "נתונה מערכת הפעלה המשתמשת בזיכרון וירטואלי עם כתובות וירטואליות בגודל 32 ביט וגודל עמוד (page size) של 4KB. מערכת טבלאות העמודים היא דו-מפלסית (two-level page table), כאשר כל רמת טבלה יכולה להכיל 1024 כניסות. כל כניסת טבלה (PTE - Page Table Entry) היא בגודל 4 בתים.\nלמערכת יש גם TLB (Translation Lookaside Buffer) עם 8 כניסות, הפועל בשיטת אסוציאטיביות מלאה (fully associative) ומדיניות החלפה LRU (Least Recently Used). ה-TLB מאחסן מיפויים של כתובות וירטואליות לכתובות פיזיות עבור דפי נתונים ועבור דפי טבלאות עמודים (PTEs).\n\nנתונה תוכנית C המבצעת את הקוד הבא:\n\n```c\n#define N 1024\nint matrix[N][N]; // 4MB total size\n\nvoid access_matrix_row_major() {\n    for (int i = 0; i < N; i++) {\n        for (int j = 0; j < N; j++) {\n            matrix[i][j] = i + j;\n        }\n    }\n}\n\nvoid access_matrix_col_major() {\n    for (int j = 0; j < N; j++) {\n        for (int i = 0; i < N; i++) {\n            matrix[i][j] = i + j;\n        }\n    }\n}\n```\n\nהניחו כי המטריצה `matrix` מתחילה בכתובת וירטואלית מיושרת לעמוד (page-aligned). לפני תחילת כל אחת מהפונקציות (`access_matrix_row_major` ו-`access_matrix_col_major`), ה-TLB והזיכרון הפיזי ריקים לחלוטין (כלומר, אין עמודים טעונים לזיכרון הפיזי ואין כניסות ב-TLB). יש להתעלם מהשפעת הקוד עצמו (instruction pages) על הזיכרון.\n\nיש לחשב עבור כל אחת מהפונקציות:\n1.  מספר ה-Page Faults הכולל.\n2.  מספר ה-TLB Misses הכולל.\n\nהסבירו את חישוביכם לכל סעיף.",
      "code_snippet": "#define N 1024\nint matrix[N][N]; // 4MB total size\n\nvoid access_matrix_row_major() {\n    for (int i = 0; i < N; i++) {\n        for (int j = 0; j < N; j++) {\n            matrix[i][j] = i + j;\n        }\n    }\n}\n\nvoid access_matrix_col_major() {\n    for (int j = 0; j < N; j++) {\n        for (int i = 0; i < N; i++) {\n            matrix[i][j] = i + j;\n        }\n    }\n}"
    },
    "sub_questions": null,
    "points": null,
    "solution": {
      "is_present_in_file": true,
      "correct_option": null,
      "explanation": "נתחיל בניתוח פרמטרי המערכת:\n-   **כתובת וירטואלית:** 32 ביט.\n-   **גודל עמוד (Page Size):** 4KB = 2^12 בתים. מכאן ש-Page Offset הוא 12 ביטים.\n-   **Virtual Page Number (VPN):** 32 - 12 = 20 ביטים.\n-   **טבלאות עמודים דו-מפלסיות:** כל רמה מכילה 1024 כניסות. 1024 = 2^10. לכן, כל אינדקס ברמת הטבלה הוא 10 ביטים.\n    -   פירוק ה-VPN: P1_index (10 ביטים), P2_index (10 ביטים).\n-   **גודל המטריצה `matrix`:** `N * N * sizeof(int)` = `1024 * 1024 * 4` בתים = `4 * 1024 * 1024` בתים = 4MB.\n-   **מספר העמודים שהמטריצה תופסת:** 4MB / 4KB = 1024 עמודים.\n-   **גודל שורה במטריצה:** `1024 * 4` בתים = 4KB. כלומר, שורה שלמה מתאימה בדיוק לעמוד אחד בזיכרון.\n-   **TLB:** 8 כניסות, Fully Associative, LRU.\n\nנניח שהמטריצה `matrix` מתחילה בכתובת וירטואלית `0x00000000`. לפיכך, ה-VPNs שלה נעים מ-`0x00000` עד `0x003FF`.\n-   עבור כל ה-VPNs הללו, ה-P1_index יהיה `0` (10 הביטים העליונים של ה-VPN). כלומר, כל המטריצה ממופה על ידי כניסה אחת בטבלת העמודים מהרמה הראשונה (L1 PTE).\n-   ה-P2_index ישתנה מ-`0` עד `1023` (10 הביטים התחתונים של ה-VPN). כלומר, כל עמוד נתונים דורש כניסה נפרדת בטבלת העמודים מהרמה השנייה (L2 PTE).\n-   לכן, נדרשת טבלת עמודים אחת ברמה 1 (ה-P1_index=0) וטבלת עמודים אחת ברמה 2 (ה-P2_index=0..1023, המקושרת ל-P1_index=0). טבלת ה-L2 הזו מכילה 1024 PTEs עבור 1024 דפי הנתונים של המטריצה.\n\n---\n\n### פונקציה `access_matrix_row_major()`\n\n```c\nvoid access_matrix_row_major() {\n    for (int i = 0; i < N; i++) { // עבור כל שורה\n        for (int j = 0; j < N; j++) { // עבור כל איבר בשורה\n            matrix[i][j] = i + j;\n        }\n    }\n}\n```\n\n**1. מספר ה-Page Faults הכולל:**\n\n*   **עבור דפי נתונים:** כל שורה במטריצה היא באורך 4KB, כלומר תופסת עמוד זיכרון אחד בדיוק. כאשר אנו ניגשים לראשונה ל-`matrix[0][0]`, יתרחש Page Fault עבור העמוד המכיל את השורה הראשונה. כל הגישות הבאות ל-`matrix[0][j]` (עבור `j` שונה) יהיו לאותו עמוד שכבר נטען, ולכן לא יגרמו ל-Page Fault נוסף. כאשר הלולאה החיצונית עוברת לשורה הבאה (`i=1`), אנו ניגשים לעמוד חדש לחלוטין (`matrix[1][0]`). זה יגרום ל-Page Fault חדש. מכיוון שיש `N=1024` שורות, וכל שורה נמצאת בעמוד נפרד, יהיו `N` Page Faults עבור דפי הנתונים של המטריצה.\n    *   סה\"כ Page Faults לדפי נתונים: 1024.\n\n*   **עבור טבלאות עמודים (Page Tables):** כדי לתרגם כתובת וירטואלית, מערכת ההפעלה צריכה לגשת ל-PTEs בטבלאות העמודים. גישה ראשונה ל-PTE שאינו בזיכרון הפיזי תגרום ל-Page Fault עבור העמוד המכיל את ה-PTE הזה.\n    *   **L1 Page Table:** כל דפי המטריצה משתמשים באותו P1_index. לכן, טבלת העמודים ברמה 1 (שמכילה את ה-PTE עבור P1_index=0) תצטרך להיטען לזיכרון הפיזי פעם אחת בלבד. (1 Page Fault).\n    *   **L2 Page Tables:** כל דף נתונים של המטריצה (שורה) דורש PTE שונה בטבלת ה-L2. מכיוון שיש 1024 דפי נתונים (שורות), יש 1024 PTEs שונים ברמת L2. כל ה-PTEs הללו נמצאים באותה טבלת L2 (שכן כולם חולקים את אותו P1_index). טבלת L2 זו תצטרך להיטען לזיכרון הפיזי פעם אחת בלבד כאשר ניגשים ל-PTE הראשון שלה. (1 Page Fault).\n    *   סה\"כ Page Faults לטבלאות עמודים: 1 (עבור טבלת L1) + 1 (עבור טבלת L2) = 2.\n\n*   **סה\"כ Page Faults כולל:** 1024 (לדפי נתונים) + 2 (לטבלאות עמודים) = **1026**.\n\n**2. מספר ה-TLB Misses הכולל:**\n\n*   ה-TLB מכיל 8 כניסות ומשתמש במדיניות LRU. ה-TLB מאחסן מיפויים של דפי נתונים ודפי טבלאות עמודים.\n*   **L1 PTE:** ה-PTE של רמה 1 (עבור P1_index=0) יגרום ל-TLB Miss בפעם הראשונה שהוא נדרש. מכיוון שהוא נחוץ לתרגום כל כתובת במטריצה, וה-TLB גדול מספיק כדי להחזיק אותו יחד עם עוד 7 כניסות, סביר להניח שהוא יישאר ב-TLB לאחר הגישה הראשונה. (1 TLB Miss).\n*   **L2 PTEs:** לכל אחד מ-1024 דפי הנתונים יש PTE משלו ברמת L2. כאשר ניגשים ל-`matrix[i][j]`, נדרש ה-L2 PTE המתאים לדף `i`. מכיוון שיש 1024 L2 PTEs שונים, וה-TLB מכיל רק 8 כניסות, ה-L2 PTEs יעברו תחלופה מתמדת ב-TLB. בכל פעם שנגיע ל-PTE חדש שלא נמצא ב-TLB (או שהוצא ממנו), תהיה TLB Miss.\n    *   בכל פעם שניגשים לראשונה לדף חדש (כלומר ל-`matrix[i][0]`), יתרחש TLB Miss עבור ה-L2 PTE המתאים לו. מכיוון שיש 1024 דפי נתונים שונים, וכל גישה ל-`matrix[i][0]` גורמת ל-TLB Miss עבור ה-L2 PTE שלו, ו-8 כניסות ב-TLB אינן מספיקות להחזיק את כל ה-1024 L2 PTEs, כל גישה ל-L2 PTE שלא הייתה ב-TLB (או הוצאה ממנו) תהיה Miss. בפועל, לכל אחד מ-1024 ה-L2 PTEs תהיה לפחות Miss אחת. (1024 TLB Misses).\n*   **דפי נתונים (Data Pages):** בדומה ל-L2 PTEs, כל אחד מ-1024 דפי הנתונים יגרום ל-TLB Miss בפעם הראשונה שניגשים אליו. מכיוון שיש 1024 דפים שונים וה-TLB מכיל רק 8 כניסות, בכל פעם שנגיע לדף חדש (כלומר `matrix[i][0]`), יתרחש TLB Miss עבור מיפוי הדף הזה, והוא יעיף כניסה אחרת (LRU) מה-TLB. הגישות הבאות באותה שורה (`matrix[i][j]` עבור `j>0`) יהיו TLB Hits. לכן, יהיו 1024 TLB Misses עבור דפי הנתונים. (1024 TLB Misses).\n\n*   **סה\"כ TLB Misses כולל:** 1 (L1 PTE) + 1024 (L2 PTEs) + 1024 (דפי נתונים) = **2049**.\n\n---\n\n### פונקציה `access_matrix_col_major()`\n\n```c\nvoid access_matrix_col_major() {\n    for (int j = 0; j < N; j++) { // עבור כל עמודה\n        for (int i = 0; i < N; i++) { // עבור כל איבר בעמודה\n            matrix[i][j] = i + j;\n        }\n    }\n}\n```\n\n**1. מספר ה-Page Faults הכולל:**\n\n*   **עבור דפי נתונים:** כאשר אנו ניגשים ל-`matrix[0][0]`, יתרחש Page Fault עבור העמוד המכיל את השורה הראשונה (דף 0). כאשר אנו ממשיכים ל-`matrix[1][0]`, יתרחש Page Fault עבור העמוד המכיל את השורה השנייה (דף 1), וכן הלאה. עבור העמודה הראשונה (`j=0`), אנו ניגשים ל-`N` דפים שונים (דף 0 עד דף 1023). כל אחת מהגישות האלו תגרום ל-Page Fault, מכיוון שכל הדפים הללו טרם נטענו. סה\"כ `N=1024` Page Faults עבור העמודה הראשונה. כאשר אנו עוברים לעמודות הבאות (`j=1`, `j=2` וכו'), אנו ניגשים לאותם דפים בדיוק שכבר נטענו (דף 0, דף 1, ..., דף 1023), אך בקיזוז (offset) שונה בתוך כל דף. מכיוון שהדפים כבר טעונים לזיכרון הפיזי, לא יתרחשו Page Faults נוספים עבור העמודות הבאות.\n    *   סה\"כ Page Faults לדפי נתונים: 1024.\n\n*   **עבור טבלאות עמודים (Page Tables):** זהה לתרחיש ה-row-major. טבלת L1 וטבלת L2 יגרמו כל אחת ל-Page Fault פעם אחת כדי להיטען לזיכרון הפיזי.\n    *   סה\"כ Page Faults לטבלאות עמודים: 1 (עבור טבלת L1) + 1 (עבור טבלת L2) = 2.\n\n*   **סה\"כ Page Faults כולל:** 1024 (לדפי נתונים) + 2 (לטבלאות עמודים) = **1026**.\n\n**2. מספר ה-TLB Misses הכולל:**\n\n*   **L1 PTE:** בדומה למקרה הקודם, ה-L1 PTE יגרום ל-TLB Miss אחד בפעם הראשונה שיידרש, ויישאר ב-TLB. (1 TLB Miss).\n\n*   **L2 PTEs ודפי נתונים (Data Pages):** בתרחיש של גישה לפי עמודות, ה-locality נמוכה מאוד. בכל איטרציה של הלולאה הפנימית (`for i`), אנו ניגשים לעמוד חדש (`matrix[i][j]` נמצא בדף `i`). מכיוון שה-TLB מכיל רק 8 כניסות, וכבר לאחר 8 גישות אנו עוברים 8 דפים שונים, הכניסות הישנות ב-TLB יפונו לפי מדיניות LRU. כשאנו ממשיכים באותה עמודה ומגיעים ל-`matrix[8][j]`, ה-PTE עבור דף 0 (שנכנס ראשון) כבר יצא מה-TLB. כשאנו מגיעים ל-`matrix[0][j+1]` (למשל, אחרי שסיימנו את כל העמודה הראשונה), ה-PTE עבור דף 0 כבר יצא מה-TLB (מאות פעמים).\n    *   לכן, **כל גישה** ל-`matrix[i][j]` תגרום ל-TLB Miss עבור מיפוי דף הנתונים המתאים (דף `i`).\n    *   בנוסף, **כל גישה** ל-`matrix[i][j]` תגרום ל-TLB Miss עבור ה-L2 PTE המתאים לו (שכן גם ה-L2 PTEs עבור דפים `0` עד `1023` יוחלפו באופן קבוע ב-TLB הקטן).\n    *   מספר הגישות הכולל למטריצה הוא `N * N = 1024 * 1024 = 1,048,576`.\n    *   לכן, יהיו `1024 * 1024` TLB Misses עבור דפי הנתונים, ו-`1024 * 1024` TLB Misses עבור ה-L2 PTEs.\n\n*   **סה\"כ TLB Misses כולל:** 1 (L1 PTE) + (1024 * 1024 עבור L2 PTEs) + (1024 * 1024 עבור דפי נתונים) = 1 + 1,048,576 + 1,048,576 = **2,097,153**.\n\n**סיכום והשוואה:**\n-   מספר ה-Page Faults זהה בשני המקרים (1026) מכיוון שכל דפי הנתונים וטבלאות העמודים נטענים לזיכרון הפיזי פעם אחת.\n-   מספר ה-TLB Misses שונה באופן דרמטי:\n    -   `access_matrix_row_major`: 2049 TLB Misses, מכיוון שיש locality טובה בגישה לדפי נתונים ו-L2 PTEs בתוך כל שורה.\n    -   `access_matrix_col_major`: 2,097,153 TLB Misses, מכיוון שאין locality בגישה לדפי נתונים ול-L2 PTEs, וכל גישה כמעט גורמת ל-TLB Miss."
    },
    "difficulty_estimation": "Hard"
  }
}